name: "Server deploy"

on:
  push:
    branch:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    

    steps:
    - name: Checkout code
      uses: actions/Checkout@v3

    - name: Deploy over SSH
      uses: appleboy/ssh-actions@1.0.3
      with:
        host: ${{secrets.DB_HOST}}
        username: ${{secrets.DB_USER}}
        key: ${{secrets.SSH_KEY}}
        scripts:
            echo "ğŸš€ Boshlanmoqda loyihani yaratish yoki mavjud boâ€˜lsa yangilash..."
            mkdir -p /home/ubuntu/CI-CD
            cd /home/ubuntu/CI-CD

            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Git repo clone qilinmoqda..."
              git clone https://github.com/aziz-davronov107/CI-CD.git .
            else
              echo "ğŸ”„ Git repodan yangilanishlar olinmoqda..."
              git pull origin main
            fi

            echo "ğŸ§¹ Docker konteynerlar toâ€˜xtatilmoqda..."
            docker-compose down

            echo "ğŸ—ï¸ Docker image rebuild qilinmoqda..."
            docker-compose up build --no-cache

            echo "ğŸ”¥ Docker konteynerlar ishga tushirilmoqda..."
            docker-compose up -d

            echo "Succesfully"
            echo "âœ… Deploy muvaffaqiyatli yakunlandi!"
